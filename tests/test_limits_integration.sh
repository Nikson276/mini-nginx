#!/bin/bash
# Integration test for connection limits with real upstream servers
# 
# –≠—Ç–æ—Ç —Å–∫—Ä–∏–ø—Ç —Ç–µ—Å—Ç–∏—Ä—É–µ—Ç –ª–∏–º–∏—Ç—ã —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π –∫ upstream:
# 1. –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å –ø—Ä–æ–∫—Å–∏ –∏ upstream —Å–µ—Ä–≤–µ—Ä–æ–≤
# 2. –î–µ–ª–∞–µ—Ç –Ω–µ—Å–∫–æ–ª—å–∫–æ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ –ø—Ä–æ–∫—Å–∏
# 3. –ü—Ä–æ–≤–µ—Ä—è–µ—Ç, —á—Ç–æ –ª–∏–º–∏—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π –∫ upstream —Ä–∞–±–æ—Ç–∞–µ—Ç
#
# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:
#   ./tests/test_limits_integration.sh
#
# –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è:
#   - –ü—Ä–æ–∫—Å–∏ —Å–µ—Ä–≤–µ—Ä –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –∑–∞–ø—É—â–µ–Ω –Ω–∞ 127.0.0.1:8080
#   - –î–≤–∞ upstream —Å–µ—Ä–≤–µ—Ä–∞ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –∑–∞–ø—É—â–µ–Ω—ã –Ω–∞ 9001 –∏ 9002
#   - –õ–∏–º–∏—Ç max_conns_per_upstream –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –≤ 1 –¥–ª—è —Ç–µ—Å—Ç–∞

set -e

PROXY_URL="http://127.0.0.1:8080"
UPSTREAM1_PORT=9001
UPSTREAM2_PORT=9002

# –¶–≤–µ—Ç–∞ –¥–ª—è –≤—ã–≤–æ–¥–∞
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
NC='\033[0m' # No Color

echo "=========================================="
echo "–¢–µ—Å—Ç –ª–∏–º–∏—Ç–æ–≤ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π –∫ upstream"
echo "=========================================="
echo ""
echo "–≠—Ç–æ—Ç —Ç–µ—Å—Ç –ø—Ä–æ–≤–µ—Ä—è–µ—Ç, —á—Ç–æ –ª–∏–º–∏—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π –∫ upstream —Ä–∞–±–æ—Ç–∞–µ—Ç."
echo "–ï—Å–ª–∏ –ª–∏–º–∏—Ç —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –≤ 1, —Ç–æ —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω –∑–∞–ø—Ä–æ—Å –º–æ–∂–µ—Ç –±—ã—Ç—å"
echo "–æ–±—Ä–∞–±–æ—Ç–∞–Ω –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ upstream."
echo ""

# –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –ø—Ä–æ–∫—Å–∏ –¥–æ—Å—Ç—É–ø–µ–Ω
echo "–ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –ø—Ä–æ–∫—Å–∏..."
if ! curl -s --connect-timeout 2 "$PROXY_URL" > /dev/null 2>&1; then
    echo -e "${RED}‚ùå –û—à–∏–±–∫–∞: –ü—Ä–æ–∫—Å–∏ —Å–µ—Ä–≤–µ—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω –Ω–∞ $PROXY_URL${NC}"
    echo "   –ó–∞–ø—É—Å—Ç–∏—Ç–µ –ø—Ä–æ–∫—Å–∏: python3 -m proxy.main"
    exit 1
fi
echo -e "${GREEN}‚úÖ –ü—Ä–æ–∫—Å–∏ –¥–æ—Å—Ç—É–ø–µ–Ω${NC}"
echo ""

# –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ upstream —Å–µ—Ä–≤–µ—Ä—ã –¥–æ—Å—Ç—É–ø–Ω—ã
echo "–ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ upstream —Å–µ—Ä–≤–µ—Ä–æ–≤..."
UPSTREAM1_OK=false
UPSTREAM2_OK=false

if curl -s --connect-timeout 2 "http://127.0.0.1:$UPSTREAM1_PORT" > /dev/null 2>&1; then
    echo -e "${GREEN}‚úÖ Upstream –Ω–∞ –ø–æ—Ä—Ç—É $UPSTREAM1_PORT –¥–æ—Å—Ç—É–ø–µ–Ω${NC}"
    UPSTREAM1_OK=true
else
    echo -e "${YELLOW}‚ö†Ô∏è  –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ: Upstream –Ω–∞ –ø–æ—Ä—Ç—É $UPSTREAM1_PORT –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω${NC}"
    echo "   –ó–∞–ø—É—Å—Ç–∏—Ç–µ: uvicorn tests.echo_app:app --host 127.0.0.1 --port $UPSTREAM1_PORT"
fi

if curl -s --connect-timeout 2 "http://127.0.0.1:$UPSTREAM2_PORT" > /dev/null 2>&1; then
    echo -e "${GREEN}‚úÖ Upstream –Ω–∞ –ø–æ—Ä—Ç—É $UPSTREAM2_PORT –¥–æ—Å—Ç—É–ø–µ–Ω${NC}"
    UPSTREAM2_OK=true
else
    echo -e "${YELLOW}‚ö†Ô∏è  –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ: Upstream –Ω–∞ –ø–æ—Ä—Ç—É $UPSTREAM2_PORT –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω${NC}"
    echo "   –ó–∞–ø—É—Å—Ç–∏—Ç–µ: uvicorn tests.echo_app:app --host 127.0.0.1 --port $UPSTREAM2_PORT"
fi
echo ""

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞–ø—Ä–æ—Å–∞ —Å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ–º –≤—Ä–µ–º–µ–Ω–∏
make_request() {
    local request_num=$1
    local start_delay=$2
    
    # –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –ø–µ—Ä–µ–¥ –Ω–∞—á–∞–ª–æ–º –∑–∞–ø—Ä–æ—Å–∞ (–¥–ª—è —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –≤–æ –≤—Ä–µ–º–µ–Ω–∏)
    sleep "$start_delay"
    
    echo "[$(date +%H:%M:%S.%3N)] –ó–∞–ø—Ä–æ—Å $request_num: –ù–∞—á–∞–ª–æ"
    
    start_time=$(date +%s.%N)
    
    # –î–µ–ª–∞–µ–º –∑–∞–ø—Ä–æ—Å —Å —É–Ω–∏–∫–∞–ª—å–Ω—ã–º —Ç–µ–ª–æ–º –¥–ª—è –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏
    response=$(curl -s -w "\n%{http_code}" -X POST "$PROXY_URL/echo" \
        -H "Content-Type: text/plain" \
        -d "test-request-$request_num-$(date +%s)" \
        --max-time 30 2>&1)
    
    end_time=$(date +%s.%N)
    
    http_code=$(echo "$response" | tail -n1)
    duration=$(echo "$end_time - $start_time" | awk '{printf "%.2f", $1}')
    
    if [ "$http_code" = "200" ]; then
        echo -e "${GREEN}[$(date +%H:%M:%S.%3N)] –ó–∞–ø—Ä–æ—Å $request_num: ‚úÖ –£—Å–ø–µ—à–Ω–æ –∑–∞ ${duration}s${NC}"
        return 0
    else
        echo -e "${RED}[$(date +%H:%M:%S.%3N)] –ó–∞–ø—Ä–æ—Å $request_num: ‚ùå –û—à–∏–±–∫–∞ HTTP $http_code –∑–∞ ${duration}s${NC}"
        return 1
    fi
}

# –¢–µ—Å—Ç 1: –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –ª–∏–º–∏—Ç–∞
echo "=========================================="
echo "–¢–µ—Å—Ç 1: –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã (–ø—Ä–æ–≤–µ—Ä–∫–∞ –ª–∏–º–∏—Ç–∞)"
echo "=========================================="
echo ""
echo "–î–µ–ª–∞–µ–º 5 –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ..."
echo "–° –ª–∏–º–∏—Ç–æ–º max_conns_per_upstream=1:"
echo "- –ó–∞–ø—Ä–æ—Å—ã –∫ –æ–¥–Ω–æ–º—É upstream –¥–æ–ª–∂–Ω—ã –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å—Å—è –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ"
echo "- –ó–∞–ø—Ä–æ—Å—ã –∫ —Ä–∞–∑–Ω—ã–º upstream –º–æ–≥—É—Ç –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å—Å—è –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ"
echo ""

# –ó–∞–ø—É—Å–∫–∞–µ–º 5 –∑–∞–ø—Ä–æ—Å–æ–≤ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ (–ø–æ—á—Ç–∏)
# –ó–∞–¥–µ—Ä–∂–∫–∏ 0.01, 0.02, 0.03, 0.04, 0.05 –¥–ª—è –Ω–µ–±–æ–ª—å—à–æ–≥–æ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è
make_request 1 0.01 &
PID1=$!
make_request 2 0.02 &
PID2=$!
make_request 3 0.03 &
PID3=$!
make_request 4 0.04 &
PID4=$!
make_request 5 0.05 &
PID5=$!

# –ñ–¥–µ–º –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –≤—Å–µ—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
wait $PID1 $PID2 $PID3 $PID4 $PID5

echo ""
echo "=========================================="
echo "–¢–µ—Å—Ç 2: –ü–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã (–ø—Ä–æ–≤–µ—Ä–∫–∞ round-robin)"
echo "=========================================="
echo ""
echo "–î–µ–ª–∞–µ–º 6 –∑–∞–ø—Ä–æ—Å–æ–≤ –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ round-robin..."
echo "–û–∂–∏–¥–∞–µ–º–æ–µ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ: 9001 ‚Üí 9002 ‚Üí 9001 ‚Üí 9002 ‚Üí 9001 ‚Üí 9002"
echo ""

for i in {1..6}; do
    make_request $i 0.0
    sleep 0.1  # –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –º–µ–∂–¥—É –∑–∞–ø—Ä–æ—Å–∞–º–∏
done

echo ""
echo "=========================================="
echo "–¢–µ—Å—Ç 3: –ù–∞–≥—Ä—É–∑–æ—á–Ω—ã–π —Ç–µ—Å—Ç (–º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã)"
echo "=========================================="
echo ""
echo "–î–µ–ª–∞–µ–º 10 –∑–∞–ø—Ä–æ—Å–æ–≤ —Å –Ω–µ–±–æ–ª—å—à–∏–º–∏ –∑–∞–¥–µ—Ä–∂–∫–∞–º–∏..."
echo "–≠—Ç–æ –ø–æ–º–æ–∂–µ—Ç —É–≤–∏–¥–µ—Ç—å, –∫–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç –ª–∏–º–∏—Ç –ø—Ä–∏ –Ω–∞–≥—Ä—É–∑–∫–µ."
echo ""

# –ó–∞–ø—É—Å–∫–∞–µ–º 10 –∑–∞–ø—Ä–æ—Å–æ–≤ —Å –Ω–µ–±–æ–ª—å—à–∏–º–∏ –∑–∞–¥–µ—Ä–∂–∫–∞–º–∏
for i in {1..10}; do
    delay=$(echo "scale=2; $i * 0.05" | bc)
    make_request $i "$delay" &
done

# –ñ–¥–µ–º –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –≤—Å–µ—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
wait

echo ""
echo "=========================================="
echo "–¢–µ—Å—Ç –∑–∞–≤–µ—Ä—à–µ–Ω"
echo "=========================================="
echo ""
echo "üìä –ê–Ω–∞–ª–∏–∑ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤:"
echo ""
echo "–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –ø—Ä–æ–∫—Å–∏-—Å–µ—Ä–≤–µ—Ä–∞, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å:"
echo "1. –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–æ–≤ –º–µ–∂–¥—É upstream (round-robin)"
echo "   - –î–æ–ª–∂–Ω—ã —á–µ—Ä–µ–¥–æ–≤–∞—Ç—å—Å—è: 9001 ‚Üí 9002 ‚Üí 9001 ‚Üí 9002..."
echo ""
echo "2. –û–∂–∏–¥–∞–Ω–∏–µ –ø—Ä–∏ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–∏ –ª–∏–º–∏—Ç–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π –∫ upstream"
echo "   - –ï—Å–ª–∏ –ª–∏–º–∏—Ç = 1, –∑–∞–ø—Ä–æ—Å—ã –∫ –æ–¥–Ω–æ–º—É upstream –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ"
echo "   - –í—Ä–µ–º—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –±–æ–ª—å—à–µ"
echo ""
echo "3. –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ —Ä–∞–∑–Ω—ã–º upstream"
echo "   - –ó–∞–ø—Ä–æ—Å—ã –∫ —Ä–∞–∑–Ω—ã–º upstream –º–æ–≥—É—Ç –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å—Å—è –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ"
echo ""
echo "üí° –°–æ–≤–µ—Ç: –°–º–æ—Ç—Ä–∏—Ç–µ –Ω–∞ –≤—Ä–µ–º–µ–Ω–Ω—ã–µ –º–µ—Ç–∫–∏ –≤ –ª–æ–≥–∞—Ö –ø—Ä–æ–∫—Å–∏, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å"
echo "   –∫–æ–≥–¥–∞ –∑–∞–ø—Ä–æ—Å—ã –Ω–∞—á–∏–Ω–∞—é—Ç –∏ –∑–∞–∫–∞–Ω—á–∏–≤–∞—é—Ç –æ–±—Ä–∞–±–æ—Ç–∫—É."
echo ""
